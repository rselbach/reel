name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Import certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$CERTIFICATE_P12" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          
          # Set keychain for codesign
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
      
      - name: Build and sign
        env:
          SIGNING_IDENTITY: "Developer ID Application: Roberto Teixeira (LS8YD2TR79)"
        run: |
          ./build-app.sh --sign
      
      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Store credentials for notarytool
          xcrun notarytool store-credentials "NOTARIZE_PROFILE" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD"
          
          # Create zip for notarization
          ditto -c -k --keepParent .build/Reel.app .build/Reel.zip
          
          # Submit and wait
          xcrun notarytool submit .build/Reel.zip \
            --keychain-profile "NOTARIZE_PROFILE" \
            --wait
          
          # Staple
          xcrun stapler staple .build/Reel.app
      
      - name: Create DMG
        env:
          SIGNING_IDENTITY: "Developer ID Application: Roberto Teixeira (LS8YD2TR79)"
        run: |
          ./build-app.sh --dmg --sign
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: .build/Reel.dmg
          generate_release_notes: true
