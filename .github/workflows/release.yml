name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Import certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$CERTIFICATE_P12" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          
          # Set keychain for codesign
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
      
      - name: Build and sign
        env:
          SIGNING_IDENTITY: "Developer ID Application: Roberto Teixeira (LS8YD2TR79)"
        run: |
          ./build-app.sh --sign
      
      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Store credentials for notarytool
          xcrun notarytool store-credentials "NOTARIZE_PROFILE" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD"
          
          # Create zip for notarization
          ditto -c -k --keepParent .build/Reel.app .build/Reel.zip
          
          # Submit and wait
          xcrun notarytool submit .build/Reel.zip \
            --keychain-profile "NOTARIZE_PROFILE" \
            --wait
          
          # Staple
          xcrun stapler staple .build/Reel.app
      
      - name: Create DMG
        env:
          SIGNING_IDENTITY: "Developer ID Application: Roberto Teixeira (LS8YD2TR79)"
        run: |
          ./build-app.sh --dmg --sign
      
      - name: Sign update for Sparkle
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          SIGN_UPDATE=".build/artifacts/sparkle/Sparkle/bin/sign_update"
          SIGNATURE=$("$SIGN_UPDATE" .build/Reel.dmg --ed-key-file <(echo "$SPARKLE_PRIVATE_KEY"))
          echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
          echo "Sparkle signature generated"
      
      - name: Update appcast.xml
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          DMG_SIZE=$(stat -f%z .build/Reel.dmg)
          DATE=$(date -R)
          
          cat > appcast.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>Reel Updates</title>
              <link>https://raw.githubusercontent.com/rselbach/reel/main/appcast.xml</link>
              <description>Reel app updates</description>
              <language>en</language>
              <item>
                <title>Version $VERSION</title>
                <pubDate>$DATE</pubDate>
                <sparkle:version>$VERSION</sparkle:version>
                <sparkle:shortVersionString>$VERSION</sparkle:shortVersionString>
                <enclosure
                  url="https://github.com/rselbach/reel/releases/download/v$VERSION/Reel.dmg"
                  $SPARKLE_SIGNATURE
                  length="$DMG_SIZE"
                  type="application/octet-stream"/>
              </item>
            </channel>
          </rss>
          EOF
      
      - name: Commit appcast.xml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git add appcast.xml
          git commit -m "Update appcast.xml for ${GITHUB_REF#refs/tags/}" || echo "No changes to commit"
          git push origin main
      
      - name: Generate changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD > release_notes.md
          else
            git log --pretty=format:"- %s" > release_notes.md
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: .build/Reel.dmg
          body_path: release_notes.md
