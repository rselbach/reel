name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: macos-15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Import certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$CERTIFICATE_P12" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          
          # Set keychain for codesign
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
      
      - name: Build and sign
        env:
          SIGNING_IDENTITY: "Developer ID Application: Roberto Teixeira (LS8YD2TR79)"
        run: |
          ./build-app.sh --sign
      
      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Store credentials for notarytool
          xcrun notarytool store-credentials "NOTARIZE_PROFILE" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD"
          
          # Create zip for notarization
          ditto -c -k --keepParent .build/Reel.app .build/Reel.zip
          
          # Submit and wait, capture submission ID
          SUBMIT_OUTPUT=$(xcrun notarytool submit .build/Reel.zip \
            --keychain-profile "NOTARIZE_PROFILE" \
            --wait 2>&1) || true
          echo "$SUBMIT_OUTPUT"
          
          # Extract submission ID and check status
          SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
          if echo "$SUBMIT_OUTPUT" | grep -q "status: Invalid"; then
            echo "Notarization failed. Fetching log..."
            xcrun notarytool log "$SUBMISSION_ID" --keychain-profile "NOTARIZE_PROFILE"
            exit 1
          fi
          
          # Staple
          xcrun stapler staple .build/Reel.app
      
      - name: Create DMG
        env:
          SIGNING_IDENTITY: "Developer ID Application: Roberto Teixeira (LS8YD2TR79)"
        run: |
          ./build-app.sh --dmg --sign
      
      - name: Sign update for Sparkle
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          SIGN_UPDATE=".build/artifacts/sparkle/Sparkle/bin/sign_update"
          SIGNATURE=$("$SIGN_UPDATE" .build/Reel.dmg --ed-key-file <(echo "$SPARKLE_PRIVATE_KEY"))
          echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
          echo "Sparkle signature generated"
      
      - name: Generate appcast.xml
        env:
          SPARKLE_SIG: ${{ env.SPARKLE_SIGNATURE }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          DATE=$(date -R)
          
          mkdir -p _site
          printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>' > _site/appcast.xml
          printf '%s\n' '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">' >> _site/appcast.xml
          printf '%s\n' '  <channel>' >> _site/appcast.xml
          printf '%s\n' '    <title>Reel Updates</title>' >> _site/appcast.xml
          printf '%s\n' '    <link>https://rselbach.github.io/reel/appcast.xml</link>' >> _site/appcast.xml
          printf '%s\n' '    <description>Reel app updates</description>' >> _site/appcast.xml
          printf '%s\n' '    <language>en</language>' >> _site/appcast.xml
          printf '%s\n' '    <item>' >> _site/appcast.xml
          printf '%s\n' "      <title>Version ${VERSION}</title>" >> _site/appcast.xml
          printf '%s\n' "      <pubDate>${DATE}</pubDate>" >> _site/appcast.xml
          printf '%s\n' "      <sparkle:version>${VERSION}</sparkle:version>" >> _site/appcast.xml
          printf '%s\n' "      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>" >> _site/appcast.xml
          printf '%s\n' "      <enclosure url=\"https://github.com/rselbach/reel/releases/download/v${VERSION}/Reel.dmg\" ${SPARKLE_SIGNATURE} type=\"application/octet-stream\"/>" >> _site/appcast.xml
          printf '%s\n' '    </item>' >> _site/appcast.xml
          printf '%s\n' '  </channel>' >> _site/appcast.xml
          printf '%s\n' '</rss>' >> _site/appcast.xml
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site
      
      - name: Generate changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD > release_notes.md
          else
            git log --pretty=format:"- %s" > release_notes.md
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: .build/Reel.dmg
          body_path: release_notes.md

  deploy-appcast:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
